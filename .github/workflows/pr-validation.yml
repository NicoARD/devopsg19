name: PR Validation

on:
  pull_request:
    branches: [ develop, master ]

jobs:
  validate:
    runs-on: ubuntu-22.04
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: example
          MYSQL_DATABASE: world
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: '17'
        distribution: 'adopt'
        
    - name: Initialize database
      run: |
        if [ -f "databases/world.sql" ]; then
          mysql -h 127.0.0.1 -P 3306 -u root -pexample world < databases/world.sql
        fi
        if [ -f "databases/init-permissions.sql" ]; then
          mysql -h 127.0.0.1 -P 3306 -u root -pexample world < databases/init-permissions.sql
        fi
        
    - name: Compile with Maven
      run: mvn compile
      
    - name: Run tests
      run: mvn test
      
    - name: Package JAR
      run: mvn package
      
    - name: Build Docker Image
      run: docker build -t sem-methods .
      
    - name: Comment PR
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const buildStatus = '${{ job.status }}' === 'success' ? '✅ BUILD PASSED' : '❌ BUILD FAILED';
          const commentBody = `## PR Validation Results
          
          **Status:** ${buildStatus}
          **Commit:** ${{ github.sha }}
          
          Build steps:
          - Compile with Maven
          - Run tests  
          - Package JAR
          - Build Docker Image`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: commentBody
          });