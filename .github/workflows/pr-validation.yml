name: PR Validation

on:
  pull_request:
    branches: [ develop, master ]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-22.04
    
    env:
      MYSQL_HOST: 127.0.0.1
      MYSQL_PORT: 3306
      MYSQL_DATABASE: world
      MYSQL_USER: devuser
      MYSQL_PASSWORD: example
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: example
          MYSQL_DATABASE: world
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: '17'
        distribution: 'adopt'
    
    - name: Install MySQL Client
      run: |
        sudo apt-get update
        sudo apt-get install -y mysql-client
        
    - name: Wait for MySQL to be ready
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h 127.0.0.1 -P 3306 -u root -pexample --silent; then
            echo "MySQL is ready!"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done
        
    - name: Initialize database
      run: |
        echo "Loading world database schema and data..."
        mysql -h 127.0.0.1 -P 3306 -u root -pexample < databases/world.sql
        
        echo "Setting up database permissions..."
        mysql -h 127.0.0.1 -P 3306 -u root -pexample < databases/init-permissions.sql
        
        echo "Verifying database setup..."
        mysql -h 127.0.0.1 -P 3306 -u devuser -pexample world -e "SELECT COUNT(*) as table_count FROM information_schema.tables WHERE table_schema='world';"
        
    - name: Compile with Maven
      run: mvn compile
      
    - name: Run tests
      run: mvn test
      
    - name: Run integration tests
      run: mvn verify -DskipUnitTests
      
    - name: Package JAR
      run: mvn package
      
    - name: Build Docker Image
      run: docker build -t sem-methods .
      
    - name: Comment PR
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const buildStatus = '${{ job.status }}' === 'success' ? 'BUILD PASSED' : 'BUILD FAILED';
          const commentBody = `## PR Validation Results
          
          **Status:** ${buildStatus}
          **Commit:** ${{ github.sha }}
          
          Build steps:
          - Compile with Maven
          - Run tests  
          - Package JAR
          - Build Docker Image`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: commentBody
          });